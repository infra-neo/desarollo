# Caddyfile for gate.kapp4.com
# Author: Ing. Benjamín Frías — DevOps & Cloud Specialist
# Purpose: Load balancer configuration for multi-service application running in Docker

# Main domain configuration
gate.kapp4.com {
    # Enable automatic HTTPS
    # Caddy will automatically obtain and renew SSL certificates

    # Frontend application at /front
    handle /front* {
        # Strip /front prefix and proxy to frontend container on port 8080
        uri strip_prefix /front
        reverse_proxy frontend:8080
    }

    # Authentication service at /auth
    handle /auth* {
        # Proxy to backend container (auth service)
        reverse_proxy backend:8000
    }

    # Backend API at /api
    handle /api* {
        # Proxy to backend container
        reverse_proxy backend:8000
    }

    # Infrastructure builder frontend
    handle /builder* {
        # Strip /builder prefix and proxy to infrastructure builder
        uri strip_prefix /builder
        reverse_proxy builder-frontend:3000
    }

    # Health check endpoint
    handle /health {
        respond "healthy" 200
    }

    # Default route - redirect to frontend
    handle {
        redir /front permanent
    }

    # Logging
    log {
        output stdout
        format json
    }

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent content type sniffing
        X-Content-Type-Options "nosniff"
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# HTTP to HTTPS redirect
http://gate.kapp4.com {
    redir https://gate.kapp4.com{uri} permanent
}
